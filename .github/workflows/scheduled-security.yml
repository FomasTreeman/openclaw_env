name: Scheduled Security Audit

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  security-audit:
    name: Weekly Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6"

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Run Checkov Full Scan
        id: checkov
        continue-on-error: true
        run: |
          pip install checkov
          checkov -d . --framework terraform --output cli --output json --output-file-path console,checkov-report.json || true
          
          # Count issues
          CRITICAL=$(cat checkov-report.json | jq '[.results.failed_checks[] | select(.severity == "CRITICAL")] | length' 2>/dev/null || echo "0")
          HIGH=$(cat checkov-report.json | jq '[.results.failed_checks[] | select(.severity == "HIGH")] | length' 2>/dev/null || echo "0")
          MEDIUM=$(cat checkov-report.json | jq '[.results.failed_checks[] | select(.severity == "MEDIUM")] | length' 2>/dev/null || echo "0")
          TOTAL=$(cat checkov-report.json | jq '.results.failed_checks | length' 2>/dev/null || echo "0")
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Run Trivy Scan
        id: trivy
        continue-on-error: true
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy fs . --severity CRITICAL,HIGH --format json --output trivy-report.json || true
          
          VULNS=$(cat trivy-report.json | jq '[.Results[]?.Vulnerabilities // [] | .[]] | length' 2>/dev/null || echo "0")
          echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT

      - name: Check for Terraform Provider Updates
        id: providers
        run: |
          terraform providers lock -platform=linux_amd64 2>&1 | tee provider-updates.txt || true
          if grep -q "Upgrade" provider-updates.txt; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Security Report Issue
        if: steps.checkov.outputs.total > 0 || steps.trivy.outputs.vulnerabilities > 0
        uses: actions/github-script@v7
        with:
          script: |
            const checkovTotal = '${{ steps.checkov.outputs.total }}';
            const checkovCritical = '${{ steps.checkov.outputs.critical }}';
            const checkovHigh = '${{ steps.checkov.outputs.high }}';
            const trivyVulns = '${{ steps.trivy.outputs.vulnerabilities }}';
            const hasProviderUpdates = '${{ steps.providers.outputs.has_updates }}';
            
            const date = new Date().toISOString().split('T')[0];
            
            let body = `## Weekly Security Audit Report - ${date}\n\n`;
            body += `### Infrastructure Security (Checkov)\n`;
            body += `| Severity | Count |\n`;
            body += `|----------|-------|\n`;
            body += `| Critical | ${checkovCritical} |\n`;
            body += `| High | ${checkovHigh} |\n`;
            body += `| **Total** | **${checkovTotal}** |\n\n`;
            
            body += `### Dependency Vulnerabilities (Trivy)\n`;
            body += `- High/Critical vulnerabilities found: **${trivyVulns}**\n\n`;
            
            if (hasProviderUpdates === 'true') {
              body += `### Provider Updates Available\n`;
              body += `Terraform provider updates are available. Consider updating.\n\n`;
            }
            
            body += `---\n`;
            body += `*This issue was automatically generated by the scheduled security audit.*\n`;
            body += `*Run ID: ${{ github.run_id }}*`;
            
            // Check for existing open security audit issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security-audit'
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log(`Updated existing issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”’ Security Audit Report - ${date}`,
                body: body,
                labels: ['security-audit', 'automated']
              });
              console.log('Created new security audit issue');
            }

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: |
            checkov-report.json
            trivy-report.json
            provider-updates.txt
          retention-days: 30
