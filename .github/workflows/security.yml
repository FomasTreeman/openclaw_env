name: Security & Quality Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  # ==========================================================================
  # VALIDATION JOBS - Run all checks, fail on any issues (errors or warnings)
  # ==========================================================================

  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    outputs:
      validate_status: ${{ steps.validate.outcome }}
      fmt_status: ${{ steps.fmt.outcome }}
      has_issues: ${{ steps.fmt.outcome == 'failure' || steps.validate.outcome == 'failure' }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6"

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Format Check
        id: fmt
        continue-on-error: true
        run: |
          OUTPUT=$(terraform fmt -check -recursive -diff 2>&1)
          if [[ -n "$OUTPUT" ]]; then
            echo "$OUTPUT"
            echo "$OUTPUT" > fmt_diff.txt
            echo "::error::Terraform formatting issues found"
            exit 1
          fi

      - name: Terraform Validate
        id: validate
        continue-on-error: true
        run: |
          if ! terraform validate; then
            echo "::error::Terraform validation failed"
            exit 1
          fi

      - name: Upload format diff
        if: steps.fmt.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-fmt-diff
          path: fmt_diff.txt

  checkov:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.scan.outcome }}
      has_issues: ${{ steps.check.outputs.has_issues }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        id: scan
        continue-on-error: true
        run: |
          pip install checkov
          # Run checkov and capture output
          checkov -d . --framework terraform --output cli --output json --output-file-path console,checkov-results.json 2>&1 | tee checkov-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Check for issues
        id: check
        run: |
          if [[ -f checkov-results.json ]]; then
            FAILED=$(cat checkov-results.json | jq '.results.failed_checks | length' 2>/dev/null || echo "0")
            if [[ "$FAILED" -gt 0 ]]; then
              echo "::warning::Checkov found $FAILED security issues"
              echo "has_issues=true" >> $GITHUB_OUTPUT
            else
              echo "has_issues=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: |
            checkov-results.json
            checkov-output.txt

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.lint.outcome }}
      has_issues: ${{ steps.lint.outcome == 'failure' }}
    steps:
      - uses: actions/checkout@v4

      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        id: lint
        continue-on-error: true
        run: |
          OUTPUT=$(tflint --format compact 2>&1)
          if [[ -n "$OUTPUT" ]]; then
            echo "$OUTPUT"
            echo "::error::TFLint found issues"
            exit 1
          fi

  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.scan.outcome }}
      has_issues: ${{ steps.scan.outcome == 'failure' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        id: scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.scan.outcome }}
      has_issues: ${{ steps.scan.outcome == 'failure' }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy
        id: scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH,MEDIUM'
          format: 'table'
          exit-code: '1'

  ansible:
    name: Ansible Lint
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.lint.outcome }}
      has_issues: ${{ steps.lint.outcome == 'failure' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ansible ansible-lint
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Ansible Lint
        id: lint
        continue-on-error: true
        run: |
          # Fail on any violations (errors or warnings)
          if ! ansible-lint ansible/playbook.yml --strict; then
            echo "::error::Ansible Lint found issues"
            exit 1
          fi

  # ==========================================================================
  # SUMMARY JOB - Report ALL issues and trigger auto-fix
  # ==========================================================================

  summary:
    name: Check Summary
    runs-on: ubuntu-latest
    needs: [terraform, checkov, tflint, gitleaks, trivy, ansible]
    if: always()
    outputs:
      any_failed: ${{ steps.summary.outputs.any_failed }}
      fixable_failed: ${{ steps.summary.outputs.fixable_failed }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate Summary
        id: summary
        run: |
          echo "## Security & Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Auto-Fixable |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------------|" >> $GITHUB_STEP_SUMMARY
          
          ANY_FAILED="false"
          FIXABLE_FAILED="false"
          
          # Terraform Validate
          if [[ "${{ needs.terraform.outputs.validate_status }}" == "failure" ]]; then
            echo "| Terraform Validate | âŒ Failed | No |" >> $GITHUB_STEP_SUMMARY
            ANY_FAILED="true"
          else
            echo "| Terraform Validate | âœ… Passed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Terraform Format
          if [[ "${{ needs.terraform.outputs.fmt_status }}" == "failure" ]]; then
            echo "| Terraform Format | âŒ Failed | âœ… Yes |" >> $GITHUB_STEP_SUMMARY
            ANY_FAILED="true"
            FIXABLE_FAILED="true"
          else
            echo "| Terraform Format | âœ… Passed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Checkov
          if [[ "${{ needs.checkov.outputs.has_issues }}" == "true" ]]; then
            echo "| Checkov Security | âš ï¸ Issues Found | No |" >> $GITHUB_STEP_SUMMARY
            ANY_FAILED="true"
          else
            echo "| Checkov Security | âœ… Passed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # TFLint
          if [[ "${{ needs.tflint.outputs.status }}" == "failure" ]]; then
            echo "| TFLint | âŒ Failed | âœ… Yes |" >> $GITHUB_STEP_SUMMARY
            ANY_FAILED="true"
            FIXABLE_FAILED="true"
          else
            echo "| TFLint | âœ… Passed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Gitleaks
          if [[ "${{ needs.gitleaks.outputs.status }}" == "failure" ]]; then
            echo "| Gitleaks Secrets | ðŸš¨ SECRETS FOUND | No |" >> $GITHUB_STEP_SUMMARY
            ANY_FAILED="true"
          else
            echo "| Gitleaks Secrets | âœ… Passed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Trivy
          if [[ "${{ needs.trivy.outputs.status }}" == "failure" ]]; then
            echo "| Trivy Vulnerabilities | âš ï¸ Issues Found | No |" >> $GITHUB_STEP_SUMMARY
            ANY_FAILED="true"
          else
            echo "| Trivy Vulnerabilities | âœ… Passed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Ansible
          if [[ "${{ needs.ansible.outputs.status }}" == "failure" ]]; then
            echo "| Ansible Lint | âŒ Failed | âœ… Yes |" >> $GITHUB_STEP_SUMMARY
            ANY_FAILED="true"
            FIXABLE_FAILED="true"
          else
            echo "| Ansible Lint | âœ… Passed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Output summary
          echo "any_failed=$ANY_FAILED" >> $GITHUB_OUTPUT
          echo "fixable_failed=$FIXABLE_FAILED" >> $GITHUB_OUTPUT
          
          if [[ "$ANY_FAILED" == "true" ]]; then
            echo "### âš ï¸ Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [[ "$FIXABLE_FAILED" == "true" ]]; then
              echo "Some issues can be auto-fixed. A PR will be created with fixes." >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.gitleaks.outputs.status }}" == "failure" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸš¨ **CRITICAL: Secrets detected in code! This must be fixed manually.**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âœ… All Checks Passed" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # AUTO-FIX JOB - Always attempt fixes when fixable checks fail
  # ==========================================================================

  auto-fix:
    name: Auto-Fix & Create PR
    runs-on: ubuntu-latest
    needs: [terraform, tflint, ansible, checkov, gitleaks, trivy]
    # Run if ANY of the fixable checks failed, regardless of other job status
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      (
        needs.terraform.outputs.fmt_status == 'failure' ||
        needs.tflint.outputs.status == 'failure' ||
        needs.ansible.outputs.status == 'failure'
      )
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6"

      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ansible ansible-lint

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Apply Terraform Format Fixes
        run: |
          echo "Applying terraform fmt..."
          terraform fmt -recursive
          git diff --stat

      - name: Apply TFLint Fixes
        run: |
          echo "Applying tflint fixes..."
          tflint --init
          tflint --fix || true
          git diff --stat

      - name: Apply Ansible Lint Fixes
        run: |
          echo "Applying ansible-lint fixes..."
          ansible-galaxy collection install -r ansible/requirements.yml
          ansible-lint ansible/playbook.yml --fix || true
          # Also fix any yaml formatting
          ansible-lint ansible/*.yml --fix || true
          git diff --stat

      - name: Check for changes
        id: changes
        run: |
          git diff --stat
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "### ðŸ”§ Auto-fix changes:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git status --short >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "### â„¹ï¸ No auto-fixable changes" >> $GITHUB_STEP_SUMMARY
            echo "The issues found require manual intervention." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-fix linting and formatting issues"
          title: "ðŸ”§ Auto-fix: Linting and formatting corrections"
          body: |
            ## Automated Fixes Applied

            This PR contains automatic fixes for issues detected by CI.

            ### Fixes Applied
            - Terraform formatting (`terraform fmt -recursive`)
            - TFLint auto-fixes (`tflint --fix`)
            - Ansible Lint auto-fixes (`ansible-lint --fix`)

            ### What to Review
            - [ ] Verify the changes are correct
            - [ ] Ensure no unintended modifications
            - [ ] Check that CI passes on this PR

            ### Issues NOT Fixed (require manual attention)
            - Checkov security findings (review and fix manually)
            - Trivy vulnerability findings (update dependencies)
            - Any secret detection issues (remove secrets immediately)

            ---
            *Automatically generated by the security workflow.*
            *Triggered by: ${{ github.sha }}*
          branch: auto-fix/ci-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            ci-fix

      - name: Summary if no PR created
        if: steps.changes.outputs.has_changes == 'false'
        run: |
          echo "::warning::Issues were detected but none could be auto-fixed. Manual intervention required."

  # ==========================================================================
  # FINAL STATUS - Fails the workflow if there were unfixable issues
  # ==========================================================================

  status:
    name: Final Status
    runs-on: ubuntu-latest
    needs: [terraform, checkov, tflint, gitleaks, trivy, ansible, summary, auto-fix]
    if: always()
    steps:
      - name: Check overall status
        run: |
          echo "## Final Status Check" >> $GITHUB_STEP_SUMMARY
          
          # Check for critical failures that can't be auto-fixed
          CRITICAL_FAIL="false"
          
          if [[ "${{ needs.terraform.outputs.validate_status }}" == "failure" ]]; then
            echo "âŒ Terraform validation failed (cannot auto-fix)" >> $GITHUB_STEP_SUMMARY
            CRITICAL_FAIL="true"
          fi
          
          if [[ "${{ needs.gitleaks.outputs.status }}" == "failure" ]]; then
            echo "ðŸš¨ SECRETS DETECTED - Must be fixed manually!" >> $GITHUB_STEP_SUMMARY
            CRITICAL_FAIL="true"
          fi
          
          if [[ "${{ needs.checkov.outputs.has_issues }}" == "true" ]]; then
            echo "âš ï¸ Checkov security issues found (review recommended)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.trivy.outputs.status }}" == "failure" ]]; then
            echo "âš ï¸ Trivy vulnerabilities found (review recommended)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check if auto-fix created a PR
          if [[ "${{ needs.auto-fix.result }}" == "success" ]]; then
            echo "âœ… Auto-fix PR created - please review and merge" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail if critical issues
          if [[ "$CRITICAL_FAIL" == "true" ]]; then
            echo "::error::Critical issues found that require manual intervention"
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Workflow completed. Review any warnings above." >> $GITHUB_STEP_SUMMARY
