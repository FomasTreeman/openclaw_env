name: Security Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Validate Terraform syntax and configuration
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6"
      - name: Terraform Init
        run: terraform init -backend=false
      - name: Terraform Validate
        run: terraform validate

  # Scan Terraform for security issues
  checkov:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          soft_fail: true  # Allow warnings, fail on errors
          output_format: sarif

  # Scan for accidentally committed secrets
  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Scan for vulnerabilities in dependencies
  trivy:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  # Lint IAM policies for errors
  parliament:
    name: IAM Policy Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install parliament
      - name: Lint IAM policies
        run: |
          find policies/ -name "*.json" -exec parliament --file {} \;

  # Validate Ansible playbook syntax
  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Ansible and lint
        run: |
          pip install ansible ansible-lint
          ansible-galaxy collection install -r ansible/requirements.yml
      - name: Lint playbook
        run: ansible-lint ansible/playbook.yml
