name: Security & Quality Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  security-events: write
  # Required for Copilot
  actions: read

jobs:
  # ==========================================================================
  # VALIDATION JOBS
  # ==========================================================================

  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    outputs:
      validate_status: ${{ steps.validate.outcome }}
      fmt_status: ${{ steps.fmt.outcome }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6"

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Format Check
        id: fmt
        continue-on-error: true
        run: |
          terraform fmt -check -recursive -diff 2>&1 | tee fmt_diff.txt
          if [[ ${PIPESTATUS[0]} -ne 0 ]]; then
            echo "::error::Terraform formatting issues found"
            exit 1
          fi

      - name: Terraform Validate
        id: validate
        continue-on-error: true
        run: terraform validate

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-results
          path: fmt_diff.txt
          if-no-files-found: ignore

  checkov:
    name: Checkov Security
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.scan.outcome }}
      failed_count: ${{ steps.parse.outputs.failed_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov
        id: scan
        continue-on-error: true
        run: |
          pip install -q checkov
          checkov -d . --framework terraform \
            --output cli --output json \
            --output-file-path console,checkov-results.json 2>&1 | tee checkov-output.txt
          
          FAILED=$(jq '.results.failed_checks | length' checkov-results.json 2>/dev/null || echo "0")
          if [[ "$FAILED" -gt 0 ]]; then
            exit 1
          fi

      - name: Parse findings
        id: parse
        if: always()
        run: |
          if [[ -f checkov-results.json ]]; then
            FAILED=$(jq '.results.failed_checks | length' checkov-results.json 2>/dev/null || echo "0")
            echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
            
            # Create readable findings
            jq -r '.results.failed_checks[] | "- **\(.check_id)**: \(.check.name)\n  - File: `\(.file_path):\(.file_line_range[0])`\n  - Resource: `\(.resource)`\n  - [Fix Guide](\(.guideline))\n"' \
              checkov-results.json > checkov-findings.md 2>/dev/null || true
          else
            echo "failed_count=0" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-results
          path: |
            checkov-results.json
            checkov-output.txt
            checkov-findings.md
          if-no-files-found: ignore

  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.lint.outcome }}
    steps:
      - uses: actions/checkout@v4

      - uses: terraform-linters/setup-tflint@v4

      - run: tflint --init

      - name: Run TFLint
        id: lint
        continue-on-error: true
        run: |
          tflint --format compact 2>&1 | tee tflint-output.txt
          [[ ! -s tflint-output.txt ]] || exit 1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tflint-results
          path: tflint-output.txt
          if-no-files-found: ignore

  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.scan.outcome }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        id: scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy:
    name: Trivy Scan
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.scan.outcome }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy
        id: scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH,MEDIUM
          format: table
          exit-code: '1'
          output: trivy-output.txt

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-results
          path: trivy-output.txt
          if-no-files-found: ignore

  ansible:
    name: Ansible Lint
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.lint.outcome }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup
        run: |
          pip install -q ansible ansible-lint
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run Ansible Lint
        id: lint
        continue-on-error: true
        run: |
          ansible-lint ansible/playbook.yml 2>&1 | tee ansible-output.txt
          [[ ! -s ansible-output.txt ]] || exit 1

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ansible-results
          path: ansible-output.txt
          if-no-files-found: ignore

  # ==========================================================================
  # AUTO-FIX WITH COPILOT
  # ==========================================================================

  autofix:
    name: Auto-Fix & Copilot PR
    runs-on: ubuntu-latest
    needs: [terraform, checkov, tflint, ansible, gitleaks, trivy]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      (
        needs.terraform.outputs.fmt_status == 'failure' ||
        needs.tflint.outputs.status == 'failure' ||
        needs.ansible.outputs.status == 'failure' ||
        needs.checkov.outputs.status == 'failure'
      )
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/download-artifact@v4
        with:
          path: ci-results
        continue-on-error: true

      - name: Setup tools
        run: |
          # Terraform
          wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
          unzip -q terraform_1.6.0_linux_amd64.zip && sudo mv terraform /usr/local/bin/
          terraform init -backend=false
          
          # Ansible
          pip install -q ansible ansible-lint
          ansible-galaxy collection install -r ansible/requirements.yml 2>/dev/null || true

      - name: Apply auto-fixes
        run: |
          echo "### Applying automatic fixes..." >> $GITHUB_STEP_SUMMARY
          
          # Terraform format
          echo "- Terraform fmt" >> $GITHUB_STEP_SUMMARY
          terraform fmt -recursive
          
          # Ansible lint fix
          echo "- Ansible lint --fix" >> $GITHUB_STEP_SUMMARY
          ansible-lint ansible/playbook.yml --fix 2>/dev/null || true
          ansible-lint ansible/*.yml --fix 2>/dev/null || true

      - name: Build PR description with findings
        id: pr_body
        run: |
          cat > pr-body.md << 'EOF'
          ## ðŸ”§ Automated Security Fixes

          This PR was automatically generated to fix issues detected by CI.

          ### âœ… Auto-Applied Fixes
          - Terraform formatting (`terraform fmt`)
          - Ansible lint fixes (`ansible-lint --fix`)

          EOF
          
          # Add Checkov findings if present
          if [[ -f ci-results/checkov-results/checkov-findings.md ]]; then
            echo "### ðŸ”’ Security Issues Requiring Review" >> pr-body.md
            echo "" >> pr-body.md
            echo "The following Checkov findings need manual fixes. **Use GitHub Copilot to help:**" >> pr-body.md
            echo "" >> pr-body.md
            echo "1. Open any file mentioned below" >> pr-body.md
            echo "2. Select the problematic code" >> pr-body.md
            echo '3. Press `Ctrl+I` (or `Cmd+I`) and ask: *"Fix this Checkov security issue"*' >> pr-body.md
            echo "" >> pr-body.md
            echo "<details><summary>View all findings (${{ needs.checkov.outputs.failed_count }} issues)</summary>" >> pr-body.md
            echo "" >> pr-body.md
            cat ci-results/checkov-results/checkov-findings.md >> pr-body.md
            echo "" >> pr-body.md
            echo "</details>" >> pr-body.md
            echo "" >> pr-body.md
          fi
          
          # Add TFLint findings
          if [[ -f ci-results/tflint-results/tflint-output.txt ]] && [[ -s ci-results/tflint-results/tflint-output.txt ]]; then
            echo "### TFLint Issues" >> pr-body.md
            echo '```' >> pr-body.md
            cat ci-results/tflint-results/tflint-output.txt >> pr-body.md
            echo '```' >> pr-body.md
            echo "" >> pr-body.md
          fi
          
          cat >> pr-body.md << 'EOF'

          ---

          ### ðŸ¤– Using Copilot to Fix Remaining Issues

          For each security finding above:

          ```
          1. Open the file in GitHub.dev (press `.` on this PR)
          2. Find the line mentioned in the finding
          3. Select the code block
          4. Open Copilot Chat (Ctrl+Shift+I)
          5. Ask: "Fix this security issue: [paste the finding]"
          6. Review and apply the suggestion
          7. Commit the changes
          ```

          Or comment on this PR with:
          ```
          @github-copilot Please suggest fixes for the Checkov security issues
          ```

          ---
          *Auto-generated by security workflow*
          EOF

      - name: Check for changes
        id: changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: auto-fix security and linting issues"
          title: "ðŸ¤– Auto-Fix: Security & linting issues (use Copilot for remaining)"
          body-path: pr-body.md
          branch: autofix/security-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            security
            copilot-help-wanted

      - name: Create Issue if no PR changes but has findings
        if: steps.changes.outputs.has_changes == 'false' && needs.checkov.outputs.failed_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let findings = '';
            
            try {
              findings = fs.readFileSync('ci-results/checkov-results/checkov-findings.md', 'utf8');
            } catch (e) {
              findings = 'See workflow run for details.';
            }
            
            const body = `## ðŸ”’ Security Issues Detected

            **${{ needs.checkov.outputs.failed_count }}** security issues need manual fixes.

            ### How to Fix with Copilot

            1. Open any file below in VS Code or GitHub.dev
            2. Select the problematic code
            3. Use Copilot: \`Ctrl+I\` â†’ "Fix this Checkov security issue"

            ### Findings

            ${findings}

            ---
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });
            
            if (issues.data.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Security Issues - Use Copilot to Fix',
                body: body,
                labels: ['security', 'automated', 'copilot-help-wanted']
              });
            }

  # ==========================================================================
  # SUMMARY
  # ==========================================================================

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [terraform, checkov, tflint, gitleaks, trivy, ansible, autofix]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Security Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          [[ "${{ needs.terraform.outputs.validate_status }}" == "failure" ]] && V="âŒ" || V="âœ…"
          [[ "${{ needs.terraform.outputs.fmt_status }}" == "failure" ]] && F="âŒ" || F="âœ…"
          [[ "${{ needs.checkov.outputs.status }}" == "failure" ]] && C="âŒ (${{ needs.checkov.outputs.failed_count }})" || C="âœ…"
          [[ "${{ needs.tflint.outputs.status }}" == "failure" ]] && T="âŒ" || T="âœ…"
          [[ "${{ needs.gitleaks.outputs.status }}" == "failure" ]] && G="ðŸš¨" || G="âœ…"
          [[ "${{ needs.trivy.outputs.status }}" == "failure" ]] && TR="âŒ" || TR="âœ…"
          [[ "${{ needs.ansible.outputs.status }}" == "failure" ]] && A="âŒ" || A="âœ…"
          
          echo "| Terraform Validate | $V |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Format | $F |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov Security | $C |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | $T |" >> $GITHUB_STEP_SUMMARY
          echo "| Gitleaks | $G |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | $TR |" >> $GITHUB_STEP_SUMMARY
          echo "| Ansible Lint | $A |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.autofix.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Auto-fix PR created" >> $GITHUB_STEP_SUMMARY
            echo "Check open PRs for fixes. Use Copilot to address remaining issues." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail on secrets
        if: needs.gitleaks.outputs.status == 'failure'
        run: |
          echo "::error::SECRETS DETECTED! Must be removed immediately."
          exit 1
